<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>직원 근속기간 계산기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .upload-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px dashed #667eea;
            text-align: center;
        }
        .upload-section.dragover {
            background: #e6f0ff;
            border-color: #4a90e2;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            font-size: 14px;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .info-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .preview-table th, .preview-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .preview-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        .preview-table tr:hover {
            background: #f5f7ff;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            margin-top: 5px;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 직원 근속기간 계산기</h1>
        
        <div class="info-section">
            <h3>📋 사용방법</h3>
            <ol>
                <li><strong>직원명부 CSV 파일</strong>을 업로드하세요 (사번, 성명, 최초입사일 컬럼 필요)</li>
                <li>데이터가 올바르게 로드되었는지 미리보기에서 확인하세요</li>
                <li><strong>"엑셀 파일 다운로드"</strong> 버튼을 클릭하여 근속기간이 계산된 엑셀 파일을 다운로드하세요</li>
                <li>근속기간은 <strong>2024년 12월 31일 기준</strong>으로 계산됩니다</li>
                <li>근속기간은 <strong>두 가지 형식</strong>으로 제공됩니다: "X년 X개월 X일" 형식과 총 개월 수</li>
            </ol>
        </div>

        <div class="upload-section" id="uploadSection">
            <h3>📁 CSV 파일 업로드</h3>
            <p>직원명부.csv 파일을 선택하거나 여기에 드래그하세요</p>
            <input type="file" id="csvFile" accept=".csv" />
            <button onclick="loadSampleData()">샘플 데이터로 테스트</button>
        </div>

        <div id="status"></div>
        
        <div id="stats" class="stats" style="display:none;"></div>
        
        <div id="preview" style="display:none;">
            <h3>📊 데이터 미리보기 (상위 10개 행)</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="previewTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <button id="downloadBtn" onclick="downloadExcel()" disabled>
                💾 엑셀 파일 다운로드
            </button>
        </div>
    </div>

    <script>
        let employeeData = [];
        let processedData = [];

        // 파일 드래그 앤 드롭 설정
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('csvFile');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileUpload();
            }
        });

        fileInput.addEventListener('change', handleFileUpload);

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showLoading(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="loading">${message}</div>`;
        }

        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            showLoading('파일을 읽는 중...');

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            try {
                const results = Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8'
                });

                if (results.errors.length > 0) {
                    console.warn('CSV 파싱 경고:', results.errors);
                }

                employeeData = results.data;
                
                // 필수 컬럼 확인
                const requiredColumns = ['사번', '성명', '최초입사일'];
                const columns = results.meta.fields;
                const missingColumns = requiredColumns.filter(col => !columns.includes(col));
                
                if (missingColumns.length > 0) {
                    showStatus(`❌ 필수 컬럼이 누락되었습니다: ${missingColumns.join(', ')}`, 'error');
                    return;
                }

                // 근속기간 계산
                calculateTenure();
                displayData();
                showStatus(`✅ 총 ${employeeData.length}명의 직원 데이터가 성공적으로 로드되었습니다!`);
                
            } catch (error) {
                showStatus(`❌ 파일 파싱 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        function calculateTenure() {
            const endDate = new Date('2024-12-31');
            
            processedData = employeeData.map(employee => {
                const startDate = new Date(employee.최초입사일);
                const tenure = getDateDifference(startDate, endDate);
                
                return {
                    사번: employee.사번,
                    성명: employee.성명,
                    최초입사일: employee.최초입사일,
                    '근속기간(2024년말기준)': tenure
                };
            });
        }

        function getDateDifference(startDate, endDate) {
            let years = endDate.getFullYear() - startDate.getFullYear();
            let months = endDate.getMonth() - startDate.getMonth();
            let days = endDate.getDate() - startDate.getDate();

            if (days < 0) {
                months--;
                const lastMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                days += lastMonth.getDate();
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            let tenureStr = '';
            if (years > 0) tenureStr += `${years}년 `;
            if (months > 0) tenureStr += `${months}개월 `;
            if (days > 0) tenureStr += `${days}일`;

            return tenureStr.trim() || '1일';
        }

        function displayData() {
            // 통계 표시
            displayStats();
            
            // 테이블 헤더
            const header = document.getElementById('tableHeader');
            header.innerHTML = `
                <tr>
                    <th>사번</th>
                    <th>성명</th>
                    <th>최초입사일</th>
                    <th>근속기간(2024년말기준)</th>
                </tr>
            `;

            // 테이블 본문 (상위 10개만 표시)
            const tbody = document.getElementById('tableBody');
            const displayData = processedData.slice(0, 10);
            
            tbody.innerHTML = displayData.map(employee => `
                <tr>
                    <td>${employee.사번}</td>
                    <td>${employee.성명}</td>
                    <td>${employee.최초입사일}</td>
                    <td>${employee['근속기간(2024년말기준)']}</td>
                </tr>
            `).join('');

            document.getElementById('preview').style.display = 'block';
            document.getElementById('downloadBtn').disabled = false;
        }

        function displayStats() {
            const statsDiv = document.getElementById('stats');
            const totalEmployees = processedData.length;
            
            // 근속기간별 분석
            const tenureAnalysis = analyzeTenure();
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalEmployees}</div>
                    <div class="stat-label">총 직원 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tenureAnalysis.over5Years}</div>
                    <div class="stat-label">5년 이상 근속</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tenureAnalysis.over10Years}</div>
                    <div class="stat-label">10년 이상 근속</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tenureAnalysis.avgYears.toFixed(1)}년</div>
                    <div class="stat-label">평균 근속기간</div>
                </div>
            `;
            
            statsDiv.style.display = 'grid';
        }

        function analyzeTenure() {
            let over5Years = 0;
            let over10Years = 0;
            let totalYears = 0;

            processedData.forEach(employee => {
                const startDate = new Date(employee.최초입사일);
                const endDate = new Date('2024-12-31');
                const years = endDate.getFullYear() - startDate.getFullYear();
                
                totalYears += years;
                if (years >= 5) over5Years++;
                if (years >= 10) over10Years++;
            });

            return {
                over5Years,
                over10Years,
                avgYears: totalYears / processedData.length
            };
        }

        function downloadExcel() {
            if (processedData.length === 0) {
                showStatus('❌ 다운로드할 데이터가 없습니다.', 'error');
                return;
            }

            showLoading('엑셀 파일을 생성하는 중...');

            try {
                // 워크북 생성
                const workbook = XLSX.utils.book_new();

                // 워크시트 데이터 준비
                const worksheetData = [
                    ['사번', '성명', '최초입사일', '근속기간(2024년말기준)'],
                    ...processedData.map(row => [
                        row.사번,
                        row.성명,
                        row.최초입사일,
                        row['근속기간(2024년말기준)']
                    ])
                ];

                // 워크시트 생성
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                // 열 너비 설정
                worksheet['!cols'] = [
                    { width: 10 }, // 사번
                    { width: 15 }, // 성명
                    { width: 15 }, // 최초입사일
                    { width: 25 }  // 근속기간
                ];

                // 워크시트를 워크북에 추가
                XLSX.utils.book_append_sheet(workbook, worksheet, '직원근속기간');

                // 파일명 생성
                const today = new Date().toISOString().split('T')[0];
                const filename = `직원근속기간_2024년말기준_${today}.xlsx`;

                // 엑셀 파일 다운로드
                XLSX.writeFile(workbook, filename);

                showStatus(`✅ 엑셀 파일이 성공적으로 다운로드되었습니다! (${filename})`);

            } catch (error) {
                showStatus(`❌ 엑셀 파일 생성 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        function loadSampleData() {
            const sampleCSV = `사번,성명,최초입사일
1001,김철수,2020-03-15
1002,이영희,2019-07-22
1003,박민수,2021-01-10
1004,정미라,2018-11-05
1005,최준호,2022-09-01
1006,홍길동,2017-06-30
1007,김미영,2023-02-14
1008,이동수,2016-12-01
1009,박서연,2020-08-25
1010,최유진,2019-04-18`;

            parseCSV(sampleCSV);
            showStatus('✅ 샘플 데이터가 로드되었습니다. 테스트용으로 사용해보세요!');
        }
    </script>
</body>
</html>